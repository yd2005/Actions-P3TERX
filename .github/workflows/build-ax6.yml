name: Build Redmi AX6 (Server - Ultimate)

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-23.05
  FEEDS_CONF: feeds.conf.default
  DIY_P1_SH: diy-immortalwrt-part1.sh
  DIY_P2_SH: diy-ax6-part2.sh
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@main

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2204)
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
        # 安装 UPX (用于极致压缩 Caddy，节省 AX6 宝贵的闪存)
        sudo apt-get install -y upx

    # --- 步骤：配置 Go 环境 (防止 runner 自带版本过旧) ---
    - name: Setup Go environment
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'
        check-latest: true

# --- 步骤：现场编译定制版 Caddy (NaïveProxy 服务端) ---
    - name: Compile Custom Caddy
      run: |
        echo "Building Custom Caddy with ForwardProxy..."
        # 1. 安装 xcaddy 构建工具
        go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest
        
        # 2. 交叉编译适配 AX6 (ARM64) 的 Caddy
        # 注意：xcaddy 会自动传递 -s -w 参数进行 Strip，无需再次手动运行 strip
        GOOS=linux GOARCH=arm64 $(go env GOPATH)/bin/xcaddy build \
          --with github.com/caddyserver/forwardproxy@caddy2=github.com/klzgrad/forwardproxy@naive
        
        # 3. 极致压缩 (UPX)
        # 删除 'strip caddy'，直接运行 UPX
        upx --best --lzma caddy
        
        # 4. 准备注入目录结构
        mkdir -p files_caddy/usr/bin
        mkdir -p files_caddy/etc/init.d
        mkdir -p files_caddy/etc/caddy
        mkdir -p files_caddy/etc/uci-defaults
        
        # 移动二进制文件
        mv caddy files_caddy/usr/bin/caddy
        chmod +x files_caddy/usr/bin/caddy
        
        # 5. 生成 Caddy 启动脚本
        cat <<EOF > files_caddy/etc/init.d/caddy
        #!/bin/sh /etc/rc.common
        START=99
        STOP=10
        SERVICE_WRITE_PID=1
        SERVICE_USE_PID=1
        
        start() {
            if [ -f /etc/caddy/Caddyfile ]; then
                service_start /usr/bin/caddy run --config /etc/caddy/Caddyfile --adapter caddyfile
            else
                echo "Caddyfile not found!"
            fi
        }
        stop() {
            service_stop /usr/bin/caddy
        }
        EOF
        chmod +x files_caddy/etc/init.d/caddy

        # 6. 生成默认 Caddyfile
        cat <<EOF > files_caddy/etc/caddy/Caddyfile
        {
            order forward_proxy before file_server
        }
        :80 {
            respond "Redmi AX6 Caddy Server is Running!"
        }
        EOF

        # 7. 首次启动自动开放防火墙端口 (80/88/443)
        cat <<EOF > files_caddy/etc/uci-defaults/99-open-caddy-ports
        #!/bin/sh
        # 开放 80 端口
        uci set firewall.caddy80=rule
        uci set firewall.caddy80.name='Allow-Caddy-80'
        uci set firewall.caddy80.src='wan'
        uci set firewall.caddy80.dest_port='80'
        uci set firewall.caddy80.target='ACCEPT'
        uci set firewall.caddy80.proto='tcp'
        
        # 开放 88 端口
        uci set firewall.caddy88=rule
        uci set firewall.caddy88.name='Allow-Caddy-88'
        uci set firewall.caddy88.src='wan'
        uci set firewall.caddy88.dest_port='88'
        uci set firewall.caddy88.target='ACCEPT'
        uci set firewall.caddy88.proto='tcp'
        
        # 开放 443 端口
        uci set firewall.caddy443=rule
        uci set firewall.caddy443.name='Allow-Caddy-443'
        uci set firewall.caddy443.src='wan'
        uci set firewall.caddy443.dest_port='443'
        uci set firewall.caddy443.target='ACCEPT'
        uci set firewall.caddy443.proto='tcp'
        
        uci commit firewall
        /etc/init.d/firewall restart
        
        rm -f /etc/uci-defaults/99-open-caddy-ports
        EOF
        chmod +x files_caddy/etc/uci-defaults/99-open-caddy-ports
