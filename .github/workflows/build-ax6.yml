name: Build Redmi AX6 (Server - Ultimate)

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-23.05
  FEEDS_CONF: feeds.conf.default
  DIY_P1_SH: diy-immortalwrt-part1.sh
  DIY_P2_SH: diy-ax6-part2.sh
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@main

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2204)
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
        sudo apt-get install -y upx

    # --- 步骤：配置 Go 环境 ---
    - name: Setup Go environment
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'
        check-latest: true

    # --- 步骤：现场编译定制版 Caddy ---
    - name: Compile Custom Caddy
      run: |
        echo "Building Custom Caddy with ForwardProxy..."
        go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest
        
        GOOS=linux GOARCH=arm64 $(go env GOPATH)/bin/xcaddy build \
          --with github.com/caddyserver/forwardproxy@caddy2=github.com/klzgrad/forwardproxy@naive
        
        upx --best --lzma caddy
        
        mkdir -p /tmp/files_caddy/usr/bin
        mkdir -p /tmp/files_caddy/etc/init.d
        mkdir -p /tmp/files_caddy/etc/caddy
        mkdir -p /tmp/files_caddy/etc/uci-defaults
        
        mv caddy /tmp/files_caddy/usr/bin/caddy
        chmod +x /tmp/files_caddy/usr/bin/caddy
        
        cat <<EOF > /tmp/files_caddy/etc/init.d/caddy
        #!/bin/sh /etc/rc.common
        START=99
        STOP=10
        SERVICE_WRITE_PID=1
        SERVICE_USE_PID=1
        start() {
            if [ -f /etc/caddy/Caddyfile ]; then
                service_start /usr/bin/caddy run --config /etc/caddy/Caddyfile --adapter caddyfile
            else
                echo "Caddyfile not found!"
            fi
        }
        stop() {
            service_stop /usr/bin/caddy
        }
        EOF
        chmod +x /tmp/files_caddy/etc/init.d/caddy

        cat <<EOF > /tmp/files_caddy/etc/caddy/Caddyfile
        {
            order forward_proxy before file_server
        }
        :80 {
            respond "Redmi AX6 Caddy Server is Running!"
        }
        EOF

        cat <<EOF > /tmp/files_caddy/etc/uci-defaults/99-open-caddy-ports
        #!/bin/sh
        uci set firewall.caddy80=rule
        uci set firewall.caddy80.name='Allow-Caddy-80'
        uci set firewall.caddy80.src='wan'
        uci set firewall.caddy80.dest_port='80'
        uci set firewall.caddy80.target='ACCEPT'
        uci set firewall.caddy80.proto='tcp'
        
        uci set firewall.caddy88=rule
        uci set firewall.caddy88.name='Allow-Caddy-88'
        uci set firewall.caddy88.src='wan'
        uci set firewall.caddy88.dest_port='88'
        uci set firewall.caddy88.target='ACCEPT'
        uci set firewall.caddy88.proto='tcp'
        
        uci set firewall.caddy443=rule
        uci set firewall.caddy443.name='Allow-Caddy-443'
        uci set firewall.caddy443.src='wan'
        uci set firewall.caddy443.dest_port='443'
        uci set firewall.caddy443.target='ACCEPT'
        uci set firewall.caddy443.proto='tcp'
        
        uci commit firewall
        /etc/init.d/firewall restart
        rm -f /etc/uci-defaults/99-open-caddy-ports
        EOF
        chmod +x /tmp/files_caddy/etc/uci-defaults/99-open-caddy-ports

    - name: Clone source code
      working-directory: /workdir
      run: |
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: Load custom feeds
      run: |
        [ -e $DIY_P1_SH ] && chmod +x $DIY_P1_SH && cd openwrt && $GITHUB_WORKSPACE/$DIY_P1_SH

    - name: Update feeds
      run: cd openwrt && ./scripts/feeds update -a

    # --- 修复 Sing-box 编译报错：替换系统 Golang 为 1.23+ ---
    - name: Fix Golang Version
      run: |
        cd openwrt
        rm -rf feeds/packages/lang/golang
        git clone https://github.com/sbwml/packages_lang_golang feeds/packages/lang/golang

    - name: Install feeds
      run: cd openwrt && ./scripts/feeds install -a

    # --- 核心修改：Load custom configuration (包含大分区适配) ---
    - name: Load custom configuration
      run: |
        [ -e files ] && mv files openwrt/files
        [ -e $DIY_P2_SH ] && chmod +x $DIY_P2_SH
        
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P2_SH
        
        # 1. 注入 Caddy (从 /tmp 绝对路径复制)
        mkdir -p files
        cp -r /tmp/files_caddy/* files/
        
        # =======================================================
        # 【大分区适配 - 关键步骤】
        # 警告：此修改会强制更改分区表以适配常见的 108M/116M 大分区 Uboot
        # =======================================================
        
        echo "Applying Big Partition Layout Patch..."
        
        # A. 修改 Makefile：解除固件大小限制
        # 将 KERNEL_SIZE 从 36M 左右改为 64M (防止编译报错)
        sed -i 's/KERNEL_SIZE := .*/KERNEL_SIZE := 65536k/' target/linux/ipq807x/image/generic.mk
        
        # B. 修改 DTS (设备树)：重新定义分区
        # 这是一个比较暴力的修改，将 ubi 分区扩大到覆盖剩余空间
        # 文件路径可能随源码版本变化，这里使用通配符查找
        DTS_FILE=$(find target/linux/ipq807x -name "ipq8074-xiaomi-redmi-router-ax6.dts")
        
        if [ -f "$DTS_FILE" ]; then
            echo "Found DTS file: $DTS_FILE"
            # 这里的逻辑是：在大分区 Uboot 中，系统通常只有一个巨大的 ubi 分区
            # 我们通过修改 DTS，告诉内核 ubi 分区的范围是 0x5c00000 开始，大小不做严格限制(依靠 UBI 自动探测)
            # 或者，我们直接修改 reg 属性。
            # 注意：ImmortalWrt 23.05 的 DTS 比较复杂，这里使用 sed 替换 rootfs 分区定义
            
            # 尝试替换 ubi 分区的 reg 值 (适配常见的 110M+ 布局)
            # 原厂通常是 <0x5c00000 0x2a00000>
            # 替换为 <0x5c00000 0x7400000> (约 116MB)
            sed -i 's/<0x5c00000 0x2a00000>/<0x5c00000 0x7400000>/g' $DTS_FILE
            
            echo "DTS patched for Big Partition."
        else
            echo "Warning: AX6 DTS file not found! Partition patch failed."
        fi
        
        # =======================================================
        
        touch .config
        
        # 基础机型设置
        echo "CONFIG_TARGET_ipq807x=y" >> .config
        echo "CONFIG_TARGET_ipq807x_generic=y" >> .config
        echo "CONFIG_TARGET_ipq807x_generic_DEVICE_xiaomi_redmi-router-ax6=y" >> .config
        
        # NSS 硬件加速
        echo "CONFIG_PACKAGE_kmod-qca-nss-dp=y" >> .config
        echo "CONFIG_PACKAGE_kmod-qca-nss-drv=y" >> .config
        echo "CONFIG_PACKAGE_kmod-qca-nss-ecm=y" >> .config
        
        # Wi-Fi 固件
        echo "CONFIG_PACKAGE_ath11k-firmware-qcn9074=n" >> .config
        echo "CONFIG_PACKAGE_ath11k-firmware-qcn9074-nss=y" >> .config
        
        # 插件列表
        echo "CONFIG_PACKAGE_sing-box=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-sing-box=y" >> .config
        
        echo "CONFIG_PACKAGE_tailscale=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-tailscale=y" >> .config
        echo "CONFIG_PACKAGE_zerotier=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-zerotier=y" >> .config
        
        echo "CONFIG_PACKAGE_luci-app-acme=y" >> .config
        echo "CONFIG_PACKAGE_acme=y" >> .config
        echo "CONFIG_PACKAGE_acme-dnsapi=y" >> .config
        echo "CONFIG_PACKAGE_socat=y" >> .config
        echo "CONFIG_PACKAGE_curl=y" >> .config
        
        echo "CONFIG_PACKAGE_luci-app-filebrowser=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-ttyd=y" >> .config
        echo "CONFIG_PACKAGE_nano=y" >> .config
        echo "CONFIG_PACKAGE_htop=y" >> .config
        
        # 清理不必要的
        echo "CONFIG_PACKAGE_dockerd=n" >> .config
        echo "CONFIG_PACKAGE_luci-app-dockerman=n" >> .config
        echo "CONFIG_PACKAGE_luci-app-passwall=n" >> .config
        echo "CONFIG_PACKAGE_luci-app-ssr-plus=n" >> .config
        echo "CONFIG_PACKAGE_luci-app-openclash=n" >> .config
        echo "CONFIG_PACKAGE_naiveproxy=n" >> .config
        
        # 压缩设置
        echo "CONFIG_STRIP_KERNEL_EXPORTS=y" >> .config
        echo "CONFIG_USE_STRIP=y" >> .config
        
        make defconfig

    - name: Download package
      id: package
      run: |
        cd openwrt
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: Compile the firmware
      id: compile
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile"
        make -j$(nproc) || make -j1 || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Organize files
      id: organize
      if: steps.compile.outputs.status == 'success'
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload firmware directory
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_AX6_Server_Ultimate_BigPartition
        path: ${{ env.FIRMWARE }}
