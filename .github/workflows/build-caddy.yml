name: Build Caddy for VPS & Routers (AX6/AX6000)

on:
  workflow_dispatch: # 手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: 'stable'

      - name: Install xcaddy
        run: go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest

      # 关键修复 1: 安装 ARM64 的交叉处理工具链
      - name: Install Dependencies (UPX & ARM Toolchain)
        run: |
          sudo apt-get update
          sudo apt-get install -y upx binutils-aarch64-linux-gnu

      # 1. 编译 AMD64 (VPS) - 使用默认 strip
      - name: Build AMD64 (VPS)
        run: |
          # 不使用 GOFLAGS，避免干扰
          GOOS=linux GOARCH=amd64 ~/go/bin/xcaddy build \
          --with github.com/caddyserver/forwardproxy@caddy2=github.com/klzgrad/forwardproxy@naive \
          --output caddy-linux-amd64

      - name: Strip AMD64
        run: strip -s caddy-linux-amd64

      # 2. 编译 ARM64 (VPS & Router) - 使用交叉 strip
      - name: Build ARM64 (VPS & AX6/AX6000)
        run: |
          GOOS=linux GOARCH=arm64 ~/go/bin/xcaddy build \
          --with github.com/caddyserver/forwardproxy@caddy2=github.com/klzgrad/forwardproxy@naive \
          --output caddy-linux-arm64

      # 关键修复 2: 使用 aarch64-linux-gnu-strip 处理 ARM64 文件
      - name: Strip ARM64
        run: aarch64-linux-gnu-strip -s caddy-linux-arm64

      # 3. 压缩生成路由器版
      - name: Create Compressed Version for Routers
        run: |
          cp caddy-linux-arm64 caddy-linux-arm64-upx
          upx --best --lzma caddy-linux-arm64-upx

      - name: Upload Artifacts to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: Caddy Build ${{ github.run_number }} (VPS + AX6/AX6000)
          files: |
            caddy-linux-amd64
            caddy-linux-arm64
            caddy-linux-arm64-upx
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
